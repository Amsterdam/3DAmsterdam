<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>%UNITY_WEB_NAME%</title>
	<link rel="stylesheet" href="style.css" />
	<script src="file-wrapper.js"></script>
	<script src="line-navigator.js"></script>
  </head>

  <body>
    <div id="sharedUrl" onclick="SelectSharedURL()" style="display:none;"></div>
	<div id="objUploadClickRegisterArea" style="display:none;">
		<input id="obj" type="file" accept=".obj,.mtl" onchange="ReadFiles(this.files)" multiple>
	</div>
    <div id="gameContainer"></div>
    <div id="loader">
      <img class="logo" src="logo.png">
      <div class="spinner"></div>
      <div class="progress"><div class="full"></div></div>
    </div>
  </body> 
  <script src="%UNITY_WEBGL_LOADER_URL%"></script>
  <script>
	  var unityInstance = UnityLoader.instantiate("gameContainer", "%UNITY_WEBGL_BUILD_URL%", {onProgress: UnityProgress});
	  
	  var unityObjectName = "FileUploads";
	  var objData = "";
	  var mtlData = "";
	  var dataType = 0;
	  
	  document.addEventListener("dragover", function(event) {
		event.preventDefault();
	  });
	  document.addEventListener("drop", function(event) {
		event.stopPropagation();
		event.preventDefault();

		ReadFiles(event.dataTransfer.files);
	  });

	  function UnityProgress(unityInstance, progress) {
		if (!unityInstance.Module) {
		  return;
		}
		const loader = document.querySelector("#loader");
		if (!unityInstance.progress) {
		  const progress = document.querySelector("#loader .progress");
		  progress.style.display = "block";
		  unityInstance.progress = progress.querySelector(".full");
		  loader.querySelector(".spinner").style.display = "none";
		}
		unityInstance.progress.style.transform = `scaleX(${progress})`;
		if (progress === 1 && !unityInstance.removeTimeout) {
		  unityInstance.removeTimeout = setTimeout(function() {
			  loader.style.display = "none";
			  
			  window.onhashchange = locationHashChanged;
			  if(window.location.hash){
				locationHashChanged();
			  }
		  }, 2000);
		}
	  }
	  
	  function locationHashChanged() {
		unityInstance.SendMessage("MainCamera", "ChangedPointFromUrl", window.location.hash.replace("#",""));
	  }

	  function SelectSharedURL() {
		window.getSelection().selectAllChildren(document.getElementById("sharedUrl"));
	  }  
	  	  
	  function BuildInUnity(){
		unityInstance.SendMessage(unityObjectName, "FinishParsing");
		//Reset file selection
		document.getElementById("obj").value = "";
	  }
	  
	  function ReadFiles(selectedFiles) {
			unityInstance.SendMessage(unityObjectName, "StartObjectParsing", selectedFiles.item(0).name);
			
			//If we selected at least one file
			if(selectedFiles && selectedFiles[0]) { 				
				//Read the obj in the file input
				for (var i = 0; i < selectedFiles.length; i++) {
					var extension = selectedFiles[i].name.split(".").pop().toLowerCase();
					if(extension == "mtl"){
						ReadFileChunkInUnity(selectedFiles[i],0,false);
					}
					else if(extension == "obj"){
						ReadFileChunkInUnity(selectedFiles[i],1,(i == selectedFiles.length-1));
					}
				}
			}	
			return true;
		} 

		function ReadFileChunkInUnity(file, extension,lastfile) {		
			var navigator = new LineNavigator(file,{chunkSize:1024*1024});
			var indexToStartWith = 0;
			var countLines = 0;
			
			navigator.readSomeLines(indexToStartWith, function linesReadHandler(err, index, lines, eof, progress) {
				if (err) { 
					finished = new Date();
					console.log('Error: ' + err);
					return;
				}				
				countLines += lines.length;
				
				var fullLine = lines.join("\n"); //adding newline required by unity to split
				unityInstance.SendMessage(unityObjectName, "ShowProgress", progress);
				
				if(extension == 0){
					unityInstance.SendMessage(unityObjectName, "ParseMTLChunk", fullLine);
				}
				else if(extension == 1){
					unityInstance.SendMessage(unityObjectName, "ParseOBJChunk", fullLine);
				}
				/*
				for (var i = 0; i < lines.length; i++) {
					if(extension == 0){
						unityInstance.SendMessage(unityObjectName, "ParseMTLChunk", lines[i]);
					}
					else if(extension == 1){
						unityInstance.SendMessage(unityObjectName, "ParseOBJChunk", lines[i]);
					}
				}	*/
				
				if (eof)  {
					if(lastfile)
					{
						BuildInUnity();
					}
					console.log('Total ' + countLines + ' lines read:');
					return;
				}
				
				navigator.readSomeLines(index + lines.length, linesReadHandler);
			});
		}
		
	</script>
</html>

