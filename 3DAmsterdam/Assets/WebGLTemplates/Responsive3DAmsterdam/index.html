<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>%UNITY_WEB_NAME%</title>
	<link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="sharedUrl" onclick="SelectSharedURL()" style="display:none;"></div>
	<div id="objUploadClickRegisterArea" class="hiddenUpload" style="display:none;">
		<input id="objFileUploadInput" type="file" accept=".obj,.mtl" onchange="ReadFiles(this.files)" multiple>
	</div>
	<div id="fzpUploadClickRegisterArea" class="hiddenUpload" style="display:none;">
		<input id="fzpFileUploadInput" type="file" accept=".fzp" onchange="ReadFiles(this.files)" multiple>
	</div>
    <div id="gameContainer"></div>
    <div id="loader">
      <img class="logo" src="logo.png">
      <div class="spinner"></div>
      <div class="progress"><div class="full"></div></div>
    </div>
  </body>

  <script src="%UNITY_WEBGL_LOADER_URL%"></script>
  <script>
	  var unityInstance = UnityLoader.instantiate("gameContainer", "%UNITY_WEBGL_BUILD_URL%" , {
		  onProgress: UnityProgress
	  });
	  var fileReader;

	  var unityObjectName = "FileUploads";
	  var objData = "";
	  var mtlData = "";
	  var dataType = 0;

	  var vissimData = "";

	  document.addEventListener("dragover", function (event) {
		  event.preventDefault();
	  });
	  document.addEventListener("drop", function (event) {
		  event.stopPropagation();
		  event.preventDefault();

		  ReadFiles(event.dataTransfer.files);
	  });

	  if ("onpointerlockchange" in document) {
		  document.addEventListener('pointerlockchange', OnCursorStateChanged, false);
		  console.log("Added on pointer lock change");
	  } else if ("onmozpointerlockchange" in document) {
		  document.addEventListener('mozpointerlockchange', OnCursorStateChanged, false);
		  console.log("Added moz on pointer lock change");
	  }
	  document.addEventListener("onblur", window.focus());

	  function UnityProgress(unityInstance, progress) {
		  if (!unityInstance.Module) {
			  return;
		  }
		  const loader = document.querySelector("#loader");
		  if (!unityInstance.progress) {
			  const progress = document.querySelector("#loader .progress");
			  progress.style.display = "block";
			  unityInstance.progress = progress.querySelector(".full");
			  loader.querySelector(".spinner").style.display = "none";
		  }
		  unityInstance.progress.style.transform = `scaleX(${progress})`;
		  if (progress === 1) {
			  loader.style.display = "none";

			  window.onhashchange = locationHashChanged;
			  if (window.location.hash) {
				  locationHashChanged();
			  }
		  }
	  }

	  function OnCursorStateChanged() {
		  console.log("cursor lock state changed");
		  if (document.pointerLockElement === document.getElementById("#canvas")) {
			  console.log("Pointer is locked");
			  window.focus();
		  } else {
			  console.log("Pointer is unlocked");
			  unityInstance.SendMessage("FirstPersonCamera", "EnableMenus");
			  unityInstance.SendMessage("FirstPersonCamera", "EnableMenusMovement");
			  window.focus();
		  }

	  }

	  function locationHashChanged() {
		  unityInstance.SendMessage("CameraModeChanger", "ChangedPointFromUrl", window.location.hash.replace("#", ""));
	  }

	  function SelectSharedURL() {
		  window.getSelection().selectAllChildren(document.getElementById("sharedUrl"));
	  }

	  function BuildInUnity() {
		  console.log("Build model in Unity");
		  unityInstance.SendMessage(unityObjectName, "LoadOBJFromJavascript");
		  //Reset file selection
		  document.getElementById("objFileUploadInput").value = "";
	  }

	  function ParseVissimInUnity() {
		  console.log("Build FZP in Unity");
		  unityInstance.SendMessage(unityObjectName, "LoadVissimFromJavascript");
		  //Reset file selection
		  document.getElementById("fzpFileUploadInput").value = "";
	  }

	  function ReadFiles(selectedFiles) {
		  //Check browser support
		  if (window.File && window.FileReader && window.FileList && window.Blob) {
			  fileReader = new FileReader();
		  } else {
			  alert("Bestanden uploaden wordt helaas niet ondersteund door deze browser.");
		  }

		  //Set the obj name to display in Unity, and open progress overlay
		  
		  //If we selected at least one file
		  if (selectedFiles && selectedFiles[0]) {
			  // check file extension
			  // check file extension vissim stuff
			  var fileExtension = selectedFiles[0].name.split(".").pop().toLowerCase();
			  if(fileExtension == "fzp")
			  {
				  fileReader.onload = function (e) {
					  console.log("FZP file loaded.");
					  //After reading the text for the OBJ
					  vissimData = e.target.result;
					  ParseVissimInUnity();
					};
					fileReader.readAsText(selectedFiles[0])
				}
				else if(fileExtension == "obj" || fileExtension == "mtl")
				{
					unityInstance.SendMessage(unityObjectName, "SetOBJFileName", selectedFiles.item(0).name);
					
					// else OBj stuff

					//parse obj and optionaly the mtl file
					var mtlFileSelectionIndex = -1;
					var objFileSelectionIndex = -1;

					//Check what index is the obj file, and optionaly the mtl file
					for (var i = 0; i < selectedFiles.length; i++) {
						var extension = selectedFiles[i].name.split(".").pop().toLowerCase();
						if (extension == "mtl") {
							console.log("MTL file");
							mtlFileSelectionIndex = i;
						} else if (extension == "obj") {
							console.log("OBJ file");
							objFileSelectionIndex = i;
						}
					}
					// obj stuff 	

					//What to do when files are done loading
					fileReader.onload = function (e) {
						console.log("OBJ file loaded.");
						//After reading the text for the OBJ
						objData = e.target.result;
						if (mtlFileSelectionIndex > -1) {
							//Load material after loading obj (optionaly)
							fileReader.onload = function (e) {
								console.log("MTL file loaded.");
								mtlData = e.target.result;
								BuildInUnity();
							};
							fileReader.readAsText(selectedFiles[mtlFileSelectionIndex]);
						} else {
							BuildInUnity();
						}
					};

					//Start loading the obj file
					if (objFileSelectionIndex != -1) {
						fileReader.readAsText(selectedFiles[objFileSelectionIndex])
					};
				}
				return true;
			}
		}
	</script>
</html>
